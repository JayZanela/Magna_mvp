import { describe, it, expect, beforeAll, afterAll } from 'vitest'
import request from 'supertest'

const BASE_URL = 'http://localhost:3000'

let accessToken: string
let secondUserToken: string
let projectId: number
let rootSuiteId: number
let childSuiteId: number
let grandChildSuiteId: number

const testUser = {
  email: `test-suite-owner-${Date.now()}@exemplo.com`,
  password: '123456',
  fullName: 'Propriet√°rio das Suites',
}

const secondTestUser = {
  email: `test-suite-member-${Date.now()}@exemplo.com`,
  password: '123456',
  fullName: 'Membro das Suites',
}

const projectData = {
  name: 'Projeto para Testes de Suites',
  description: 'Projeto dedicado aos testes de suites',
}

const suiteData = {
  name: 'Suite Principal',
  description: 'Suite raiz para testes de hierarquia',
}

describe('üìã Test Suites API - Fluxo Completo', () => {
  beforeAll(async () => {
    console.log('üöÄ Iniciando testes de suites de teste...')
    console.log(`üìß Email do owner: ${testUser.email}`)
    console.log(`üìß Email do member: ${secondTestUser.email}`)

    const ownerResponse = await request(BASE_URL)
      .post('/api/auth/register')
      .send(testUser)
      .expect(201)

    accessToken = ownerResponse.body.accessToken
    console.log(`üîë Token do owner obtido: ${accessToken.substring(0, 20)}...`)

    const memberResponse = await request(BASE_URL)
      .post('/api/auth/register')
      .send(secondTestUser)
      .expect(201)

    secondUserToken = memberResponse.body.accessToken
    console.log(
      `üîë Token do member obtido: ${secondUserToken.substring(0, 20)}...`
    )

    const projectResponse = await request(BASE_URL)
      .post('/api/projects')
      .set('Authorization', `Bearer ${accessToken}`)
      .send(projectData)
      .expect(201)

    projectId = projectResponse.body.id
    console.log(`üìÅ Projeto criado! ID: ${projectId}`)
  })

  afterAll(async () => {
    console.log('‚úÖ Testes de suites finalizados!')
  })

  describe('1Ô∏è‚É£ CREATE - Criar Suites', () => {
    it('deve criar uma suite raiz com sucesso', async () => {
      console.log('üìù Testando cria√ß√£o de suite raiz...')

      const response = await request(BASE_URL)
        .post(`/api/projects/${projectId}/suites`)
        .set('Authorization', `Bearer ${accessToken}`)
        .send(suiteData)
        .expect(201)

      expect(response.body).toHaveProperty('id')
      expect(response.body).toHaveProperty('name', suiteData.name)
      expect(response.body).toHaveProperty('description', suiteData.description)
      expect(response.body).toHaveProperty('projectId', projectId)
      expect(response.body).toHaveProperty('parentId', null)
      expect(response.body).toHaveProperty('suiteOrder')

      rootSuiteId = response.body.id
      console.log(`‚úÖ Suite raiz criada! ID: ${rootSuiteId}`)
    })

    it('deve criar uma subsuite com sucesso', async () => {
      console.log('üìù Testando cria√ß√£o de subsuite...')

      const childSuiteData = {
        name: 'Subsuite de Funcionalidades',
        description: 'Suite filha para testar hierarquia',
        parentId: rootSuiteId,
      }

      const response = await request(BASE_URL)
        .post(`/api/projects/${projectId}/suites`)
        .set('Authorization', `Bearer ${accessToken}`)
        .send(childSuiteData)
        .expect(201)

      expect(response.body).toHaveProperty('parentId', rootSuiteId)
      expect(response.body).toHaveProperty('name', childSuiteData.name)

      childSuiteId = response.body.id
      console.log(`‚úÖ Subsuite criada! ID: ${childSuiteId}`)
    })

    it('deve criar uma suite neta (3¬∫ n√≠vel)', async () => {
      console.log('üìù Testando cria√ß√£o de suite neta...')

      const grandChildSuiteData = {
        name: 'Suite de Login',
        description: 'Suite espec√≠fica para testes de login',
        parentId: childSuiteId,
      }

      const response = await request(BASE_URL)
        .post(`/api/projects/${projectId}/suites`)
        .set('Authorization', `Bearer ${accessToken}`)
        .send(grandChildSuiteData)
        .expect(201)

      expect(response.body).toHaveProperty('parentId', childSuiteId)
      expect(response.body).toHaveProperty('name', grandChildSuiteData.name)

      grandChildSuiteId = response.body.id
      console.log(`‚úÖ Suite neta criada! ID: ${grandChildSuiteId}`)
    })

    it('deve rejeitar cria√ß√£o sem token de autentica√ß√£o', async () => {
      console.log('üö´ Testando cria√ß√£o sem autentica√ß√£o...')

      const response = await request(BASE_URL)
        .post(`/api/projects/${projectId}/suites`)
        .send(suiteData)
        .expect(401)

      expect(response.body.error).toBe('Token n√£o fornecido')
      console.log('‚úÖ Acesso negado sem token')
    })

    it('deve rejeitar cria√ß√£o com parent inexistente', async () => {
      console.log('‚ùå Testando parent inexistente...')

      const invalidSuiteData = {
        name: 'Suite Inv√°lida',
        description: 'Teste com parent inexistente',
        parentId: 99999,
      }

      const response = await request(BASE_URL)
        .post(`/api/projects/${projectId}/suites`)
        .set('Authorization', `Bearer ${accessToken}`)
        .send(invalidSuiteData)
        .expect(400)

      expect(response.body.error).toBe('Suite pai n√£o encontrada')
      console.log('‚úÖ Parent inexistente rejeitado')
    })

    it('deve validar campos obrigat√≥rios', async () => {
      console.log('üìã Testando valida√ß√£o de campos...')

      const response = await request(BASE_URL)
        .post(`/api/projects/${projectId}/suites`)
        .set('Authorization', `Bearer ${accessToken}`)
        .send({
          name: '', // Nome vazio
          description: 'Suite inv√°lida',
        })
        .expect(400)

      expect(response.body.error).toBe('Dados inv√°lidos')
      expect(response.body.details).toBeDefined()
      console.log('‚úÖ Valida√ß√£o de campos funcionando')
    })
  })

  describe('2Ô∏è‚É£ READ - Buscar Suites', () => {
    it('deve listar suites do projeto em hierarquia', async () => {
      console.log('üìã Testando listagem hier√°rquica...')

      const response = await request(BASE_URL)
        .get(`/api/projects/${projectId}/suites`)
        .set('Authorization', `Bearer ${accessToken}`)
        .expect(200)

      expect(response.body).toHaveProperty('suites')
      expect(response.body).toHaveProperty('total')
      expect(response.body).toHaveProperty('projectId', projectId)
      expect(response.body.suites).toHaveLength(1) // Apenas suites raiz
      expect(response.body.total).toBe(1)

      const rootSuite = response.body.suites[0]
      expect(rootSuite.id).toBe(rootSuiteId)
      expect(rootSuite.children).toHaveLength(1)
      expect(rootSuite.children[0].id).toBe(childSuiteId)
      expect(rootSuite.children[0].children).toHaveLength(1)
      expect(rootSuite.children[0].children[0].id).toBe(grandChildSuiteId)

      console.log(
        `‚úÖ Hierarquia correta com ${response.body.total} suite(s) raiz`
      )
    })

    it('deve buscar suite espec√≠fica com breadcrumb', async () => {
      console.log('üîç Testando busca de suite espec√≠fica...')

      const response = await request(BASE_URL)
        .get(`/api/suites/${grandChildSuiteId}`)
        .set('Authorization', `Bearer ${accessToken}`)
        .expect(200)

      expect(response.body.id).toBe(grandChildSuiteId)
      expect(response.body.name).toBe('Suite de Login')
      expect(response.body.parentId).toBe(childSuiteId)
      expect(response.body).toHaveProperty('breadcrumb')

      const breadcrumb = response.body.breadcrumb
      expect(breadcrumb).toHaveLength(4) // Projeto > Suite raiz > Subsuite > Suite atual
      expect(breadcrumb[0].type).toBe('project')
      expect(breadcrumb[1].type).toBe('suite')
      expect(breadcrumb[2].type).toBe('suite')
      expect(breadcrumb[3].type).toBe('suite')

      console.log('‚úÖ Breadcrumb gerado corretamente')
    })

    it('deve buscar filhos diretos de uma suite', async () => {
      console.log('üë∂ Testando busca de filhos diretos...')

      const response = await request(BASE_URL)
        .get(`/api/suites/${childSuiteId}/children`)
        .set('Authorization', `Bearer ${accessToken}`)
        .expect(200)

      expect(response.body).toHaveProperty('children')
      expect(response.body).toHaveProperty('total', 1)
      expect(response.body.children).toHaveLength(1)
      expect(response.body.children[0].id).toBe(grandChildSuiteId)

      console.log('‚úÖ Filhos diretos listados corretamente')
    })

    it('deve negar acesso a suite sem permiss√£o', async () => {
      console.log('üö´ Testando acesso sem permiss√£o...')

      const response = await request(BASE_URL)
        .get(`/api/suites/${rootSuiteId}`)
        .set('Authorization', `Bearer ${secondUserToken}`)
        .expect(403)

      expect(response.body.error).toBe(
        'Voc√™ n√£o tem permiss√£o para acessar esta suite'
      )
      console.log('‚úÖ Acesso negado sem permiss√£o')
    })

    it('deve retornar 404 para suite inexistente', async () => {
      console.log('‚ùå Testando suite inexistente...')

      const response = await request(BASE_URL)
        .get('/api/suites/99999')
        .set('Authorization', `Bearer ${accessToken}`)
        .expect(404)

      expect(response.body.error).toBe('Suite n√£o encontrada')
      console.log('‚úÖ 404 retornado para suite inexistente')
    })
  })

  describe('3Ô∏è‚É£ UPDATE - Atualizar Suites', () => {
    it('deve atualizar dados da suite', async () => {
      console.log('‚úèÔ∏è Testando atualiza√ß√£o de suite...')

      const updateData = {
        name: 'Suite de Login Atualizada',
        description: 'Descri√ß√£o atualizada da suite de login',
        suiteOrder: 5,
      }

      const response = await request(BASE_URL)
        .put(`/api/suites/${grandChildSuiteId}`)
        .set('Authorization', `Bearer ${accessToken}`)
        .send(updateData)
        .expect(200)

      expect(response.body.name).toBe(updateData.name)
      expect(response.body.description).toBe(updateData.description)
      expect(response.body.suiteOrder).toBe(updateData.suiteOrder)

      console.log('‚úÖ Suite atualizada com sucesso')
    })

    it('deve negar atualiza√ß√£o por usu√°rio sem permiss√£o', async () => {
      console.log('üö´ Testando atualiza√ß√£o sem permiss√£o...')

      const response = await request(BASE_URL)
        .put(`/api/suites/${rootSuiteId}`)
        .set('Authorization', `Bearer ${secondUserToken}`)
        .send({ name: 'Tentativa de hack' })
        .expect(403)

      expect(response.body.error).toBe(
        'Voc√™ n√£o tem permiss√£o para editar esta suite'
      )
      console.log('‚úÖ Atualiza√ß√£o negada sem permiss√£o')
    })
  })

  describe('4Ô∏è‚É£ MOVE - Mover Suites na Hierarquia', () => {
    it('deve mover suite para outro parent', async () => {
      console.log('üîÑ Testando movimenta√ß√£o de suite...')

      const moveData = {
        newParentId: rootSuiteId, // Mover suite neta diretamente para raiz
        newOrder: 1,
      }

      const response = await request(BASE_URL)
        .put(`/api/suites/${grandChildSuiteId}/move`)
        .set('Authorization', `Bearer ${accessToken}`)
        .send(moveData)
        .expect(200)

      expect(response.body.parentId).toBe(rootSuiteId)
      expect(response.body.suiteOrder).toBe(1)

      console.log('‚úÖ Suite movida com sucesso')
    })

    it('deve mover suite para raiz (sem parent)', async () => {
      console.log('üè† Testando movimenta√ß√£o para raiz...')

      const moveData = {
        newParentId: null,
        newOrder: 0,
      }

      const response = await request(BASE_URL)
        .put(`/api/suites/${childSuiteId}/move`)
        .set('Authorization', `Bearer ${accessToken}`)
        .send(moveData)
        .expect(200)

      expect(response.body.parentId).toBe(null)
      expect(response.body.suiteOrder).toBe(0)

      console.log('‚úÖ Suite movida para raiz')
    })

    it('deve rejeitar movimenta√ß√£o que criaria ciclo', async () => {
      console.log('üîÑ Testando preven√ß√£o de ciclos...')

      const moveData = {
        newParentId: grandChildSuiteId, // Tentar mover suite raiz para sua descendente
      }

      const response = await request(BASE_URL)
        .put(`/api/suites/${rootSuiteId}/move`)
        .set('Authorization', `Bearer ${accessToken}`)
        .send(moveData)
        .expect(400)

      expect(response.body.error).toBe(
        'Esta opera√ß√£o criaria um ciclo na hierarquia'
      )
      console.log('‚úÖ Ciclo na hierarquia prevenido')
    })

    it('deve negar movimenta√ß√£o por usu√°rio sem permiss√£o', async () => {
      console.log('üö´ Testando movimenta√ß√£o sem permiss√£o...')

      const response = await request(BASE_URL)
        .put(`/api/suites/${rootSuiteId}/move`)
        .set('Authorization', `Bearer ${secondUserToken}`)
        .send({ newOrder: 10 })
        .expect(403)

      expect(response.body.error).toBe(
        'Voc√™ n√£o tem permiss√£o para mover esta suite'
      )
      console.log('‚úÖ Movimenta√ß√£o negada sem permiss√£o')
    })
  })

  describe('5Ô∏è‚É£ PERMISSIONS - Controle de Acesso', () => {
    it('deve permitir acesso ap√≥s adicionar usu√°rio ao projeto', async () => {
      console.log('üë• Testando acesso ap√≥s adicionar ao projeto...')

      const secondUserId = (
        await request(BASE_URL)
          .post('/api/auth/signin')
          .send({
            email: secondTestUser.email,
            password: secondTestUser.password,
          })
          .expect(200)
      ).body.user.id

      await request(BASE_URL)
        .post(`/api/projects/${projectId}/members`)
        .set('Authorization', `Bearer ${accessToken}`)
        .send({ userId: secondUserId, role: 'tester' })
        .expect(201)

      const response = await request(BASE_URL)
        .get(`/api/projects/${projectId}/suites`)
        .set('Authorization', `Bearer ${secondUserToken}`)
        .expect(200)

      expect(response.body.suites).toBeDefined()
      console.log('‚úÖ Acesso liberado ap√≥s adicionar ao projeto')
    })
  })

  describe('6Ô∏è‚É£ DELETE - Excluir Suites', () => {
    it('deve rejeitar exclus√£o de suite com filhos', async () => {
      console.log('üö´ Testando exclus√£o com filhos...')

      const response = await request(BASE_URL)
        .delete(`/api/suites/${rootSuiteId}`)
        .set('Authorization', `Bearer ${accessToken}`)
        .expect(400)

      expect(response.body.error).toBe(
        'N√£o √© poss√≠vel excluir uma suite que possui subsuites. Remova as subsuites primeiro.'
      )
      console.log('‚úÖ Exclus√£o com filhos bloqueada')
    })

    it('deve excluir suite folha (sem filhos)', async () => {
      console.log('üóëÔ∏è Testando exclus√£o de suite folha...')

      const response = await request(BASE_URL)
        .delete(`/api/suites/${grandChildSuiteId}`)
        .set('Authorization', `Bearer ${accessToken}`)
        .expect(200)

      expect(response.body.message).toBe('Suite exclu√≠da com sucesso')
      console.log('‚úÖ Suite folha exclu√≠da')
    })

    it('suite exclu√≠da n√£o deve mais existir', async () => {
      console.log('‚ùå Verificando exclus√£o...')

      const response = await request(BASE_URL)
        .get(`/api/suites/${grandChildSuiteId}`)
        .set('Authorization', `Bearer ${accessToken}`)
        .expect(404)

      expect(response.body.error).toBe('Suite n√£o encontrada')
      console.log('‚úÖ Suite n√£o existe ap√≥s exclus√£o')
    })

    it('deve negar exclus√£o por usu√°rio sem permiss√£o', async () => {
      console.log('üö´ Testando exclus√£o sem permiss√£o...')

      const response = await request(BASE_URL)
        .delete(`/api/suites/${childSuiteId}`)
        .set('Authorization', `Bearer ${secondUserToken}`)
        .expect(403)

      expect(response.body.error).toBe(
        'Voc√™ n√£o tem permiss√£o para excluir esta suite'
      )
      console.log('‚úÖ Exclus√£o negada sem permiss√£o')
    })
  })

  describe('7Ô∏è‚É£ EDGE CASES - Casos Especiais', () => {
    it('deve validar IDs inv√°lidos', async () => {
      console.log('üî¢ Testando IDs inv√°lidos...')

      const response = await request(BASE_URL)
        .get('/api/suites/abc')
        .set('Authorization', `Bearer ${accessToken}`)
        .expect(400)

      expect(response.body.error).toBe('ID da suite inv√°lido')
      console.log('‚úÖ IDs inv√°lidos rejeitados')
    })

    it('deve tratar projeto inexistente', async () => {
      console.log('üìÅ Testando projeto inexistente...')

      const response = await request(BASE_URL)
        .get('/api/projects/99999/suites')
        .set('Authorization', `Bearer ${accessToken}`)
        .expect(403)

      expect(response.body.error).toBe(
        'Voc√™ n√£o tem permiss√£o para acessar as suites deste projeto'
      )
      console.log('‚úÖ Projeto inexistente tratado')
    })

    it('deve manter ordena√ß√£o correta das suites', async () => {
      console.log('üìä Verificando ordena√ß√£o final...')

      const response = await request(BASE_URL)
        .get(`/api/projects/${projectId}/suites`)
        .set('Authorization', `Bearer ${accessToken}`)
        .expect(200)

      const suites = response.body.suites
      expect(suites).toHaveLength(2) // childSuite (agora na raiz) + rootSuite

      // Verificar que est√£o ordenadas por suiteOrder
      if (suites.length > 1) {
        expect(suites[0].suiteOrder).toBeLessThanOrEqual(suites[1].suiteOrder)
      }

      console.log('‚úÖ Ordena√ß√£o mantida corretamente')
    })
  })
})
